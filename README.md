# Shopee Product Matching

![Python](https://img.shields.io/badge/python-3.13+-blue.svg)
![PyTorch](https://img.shields.io/badge/PyTorch-2.0+-red.svg)
![License](https://img.shields.io/badge/license-MIT-green.svg)
![MLOps](https://img.shields.io/badge/MLOps-ready-orange.svg)

[Архипов Максим]

## Описание проекта

Проект предназначен для решения задачи поиска похожих товаров. Основная цель -
разработка мультимодальной модели, которая использует как текстовые описания,
так и изображения товаров для точного определения, относятся ли два товара к
одному и тому же продукту.

Этот проект является частью курса MLOps и демонстрирует полный цикл разработки ML-решения с использованием современных MLOps практик.

**Формат входных данных:**

- RGB изображение 1024x1024 (формат jpg)
- Текстовое описание товара

**Выходные данные:**

- 512-мерный эмбеддинг товара (похожие или одинаковые товары должны иметь схожие
  эмбеддинги)
- Для поиска похожих товаров требуется последующее применение KNN/FAISS

## Метрики

Основные метрики для оценки модели:

- **Precision@K** - точность среди топ-K предсказаний
- **Recall@K** - полнота среди топ-K предсказаний
- **F1-Score@K** - гармоническое среднее precision и recall
- **NDCG@K** - метрика оценки качества ранжирования

Ожидаемые значения метрик не менее 0.65 для F1-Score@10.

## Валидация

Для валидации используется стратифицированное разделение данных (при желании
задается в data.yaml, параметр train_ratio):

- Тренировочная выборка: 80%
- Валидационная выборка: 20%

Для воспроизводимости используется фиксированный random seed = 42.

## Данные

Датасет взят с Kaggle конкурса
[Shopee - Price Match Guarantee](https://www.kaggle.com/c/shopee-product-matching).

**Структура данных:**

- `train.csv` - метаданные товаров
- `train_images/` - изображения товаров

**Предобработка данных:**

1. Аугментация изображений
2. Балансировка классов (PK-семплер)
3. Нормализация данных
4. Токенизация текста

## Архитектура модели

### Мультимодальный подход

Проект использует двухбашенную архитектуру для обработки мультимодальных данных:

#### 1. Визуальная ветка (Image Branch)

- **Основа**: CNN архитектура
- **Функция**: Извлечение признаков из изображений
- **Выход**: 256-мерный эмбеддинг

#### 2. Текстовая ветка (Text Branch)

- **Основа**: Трансформерная модель (BERT)
- **Функция**: Извлечение смысловых признаков из текста
- **Выход**: 256-мерный эмбеддинг

#### 3. Совместный слой (Joint Layer)

- **Архитектура**: Конкатенация + L2 нормализация
- **Функция**: Объединение визуальных и текстовых признаков
- **Выход**: Финальный эмбединг

## Технологический стек

- **Фреймворк**: PyTorch Lightning
- **Мониторинг**: MLflow, TensorBoard
- **Конфигурация**: Hydra
- **Управление зависимостями**: Poetry
- **Линеринг**: Ruff

## Установка и настройка

### Установка

1. Клонируйте репозиторий:

```bash
git clone https://github.com/ваш-username/shopee-product-matching.git
cd shopee-product-matching
```

2. Установите зависимости:

```bash
poetry install
```

3. Активируйте виртуальное окружение:

```bash
poetry shell
```

4.  Скачайте датасет одним из двух способов:

При помощи dvc (секреты можно запросить в телеграмме у @pipici_pip).

- Добавьте секреты в локальный конфиг:

```bash
dvc remote modify myremote --local gdrive_client_id КРЕДЫ_1
dvc remote modify myremote --local gdrive_client_secret КРЕДЫ_2
```

- Загрузите данные:

```bash
dvc pull
```

Загрузите данные напрямую с гугл диска:

```bash
gdown --folder "https://drive.google.com/drive/folders/1uQzxZCg56fW3RxTLER9qQWkFxxTGiNyK" -O ./data --remaining-ok
```

## Использование

### Тренировка модели

Перед запуском обучения модели запустите MLflow UI для мониторинга ее обучения:

```bash
mlflow ui --port 8080
```

Для запуска тренировки в другом терминале выполните:

```bash
python shopee_product_matching/training/train.py
```

### Конфигурация тренировки

Конфигурационные файлы находятся в директории conf/. Основные параметры:

- config.yaml - основной конфигурационный файл
- data.yaml - настройки скачивания и препроцессинга данных
- image_model.yaml - настройки модели, работающей с изображениями
- text_model.yaml - настройки модели, работающей с текстом
- train.yaml - параметры обучения модели

### Метрики обучения

Во время тренировки метрики логируются в MLflow - http://localhost:8080
TensorBoard - логи в директории logs/

## Структура проекта

```text
shopee_product_matching/         # Корень проекта (репозиторий)
├── shopee_product_matching/     # Основной Python пакет
│   ├── __init__.py              # Инициализация пакета
│   ├── data/                    # Модули для работы с данными
│   │   ├── __init__.py
│   │   ├── data.py             # Датасеты
│   │   ├── datamodule.py       # DataModule для PyTorch Lightning
│   │   └── preprocess_data.py  # Предобработка данных
│   ├── models/                  # Архитектуры моделей
│   │   ├── __init__.py
│   │   ├── image_model.py      # Модель для изображений
│   │   ├── text_models.py      # Модель для текста
│   │   └── joint_model.py      # Объединенная модель
│   └── training/               # Скрипты тренировки
│   │   ├── __init__.py
│   │   └── train.py           # Основной скрипт тренировки
│   ├── logs/                  # Логи обучения от TensorBoard
├── conf/                      # Конфигурационные файлы Hydra
│   ├── config.yaml            # Основной конфиг
│   ├── data.yaml              # Конфиги загрузки и предобработки данных
│   ├── image_model.yaml       # Конфиги параметров модели для изображений
│   ├── text_model.yaml        # Конфиги параметров модели для работы с текстом
│   ├── train.yaml             # Конфигурации параметров обучения
│
├── data/                      # Данные проекта (управляется DVC)
│   ├── data.csv               # Датасет с описанием товаров и ссылками на изображения
│   └── train_images/          # Папка с изображениями
├── .dvc/                      # DVC конфигурация
│   ├── config                 # Конфиг DVC
├── pyproject.toml           # Poetry конфигурация
├── poetry.lock              # Зависимости Poetry
├── README.md                # Документация
├── .gitignore               # Игнорируемые файлы
├── .pre-commit-config.yaml  # Pre-commit конфигурация
```

## Разработка

### Установка зависимостей для разработки

```bash
# Установка с dev зависимостями
poetry install --with dev

# Установка pre-commit hooks
pre-commit install
```

### Запуск pre-commit

```bash
pre-commit run -a
```
